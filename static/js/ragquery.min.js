const VERS="0.2.20";var xlog=function(){};const stopRequest=async()=>{await confirm("Confermi Cancellazione Richeista ?")&&(cancelClientRequest(),hideSpinner())},showSpinner=()=>{const a=document.getElementById("spinner");a.classList.add("show-spinner");a.addEventListener("click",stopRequest)},hideSpinner=()=>{const a=document.getElementById("spinner");a.classList.remove("show-spinner");a.removeEventListener("click",stopRequest)};
function openApp(){setTimeout(()=>{wnds.init();Menu.init();TextInput.init();TextOutput.init();Rag.init();document.querySelector(".menu-btn").checked=!1;release();showHistory();getTheme()},10)}function showHistory(){var a=ThreadMgr.getUserMessages();a=messages2html(a);setResponseHtml(a)}function release(){document.querySelector(".release").innerHTML=VERS}const op0=function(a){wnds.wdiv.show(help1_html)};function showQuery(a){wnds.wpre.show(`\n${Rag.ragQuery}`)}
function showRagResponse(a){wnds.wpre.show(`\n${Rag.ragAnswer}`)}function showThread(a){a=ThreadMgr.getUserMessages();a=messages2text(a);wnds.wpre.show(a)}function elencoRisposte(a){a=[...Rag.answers];0==a.length&&(a=UaDb.readArray(ID_RESPONSES));0!=a.length&&(a=a.map((b,c)=>`\n[${c+1}]\n ${b.trim()}`).join("\n"),wnds.wpre.show(a))}function showContesto(a){wnds.wpre.show(Rag.ragContext)}
function elencoDati(a){var b=UaDb.getAllIds();a=[];for(var c of b)b=UaDb.read(c).length,a.push(`${c} (${b})`);c=a.join("\n ");wnds.wpre.show(c)}const showT=a=>{wnds.wpre.show(DataMgr.docs[a])};function elencoDocs(){DataMgr.readDbDocs();DataMgr.readDbDocNames();var a=DataMgr.doc_names,b=UaJtfh();let c=0;b.append("<ul>");for(const g of a){a=b;var d=a.append,e=g,f=c++;d.call(a,`
      <li><a href="#" onclick="showT(${f});">${f+1}.${e}</a></li>
  `)}b.append("</ul>");b=b.html();wnds.wdiv.show(`<br><br>${b}`)}function calcQuery(){DataMgr.readDbDocs();DataMgr.readDbDocNames();var a=[];let b=0,c=0;a.push("Documento   Num.Parti");a.push("==================");for(const d of DataMgr.docs){const e=DataMgr.doc_names[c];c+=1;const f=Math.ceil(d.length/MAX_PROMPT_LENGTH);b+=f;a.push(`${e}&nbsp;&nbsp;&nbsp;[${f}]`)}a.push("==================");a.push(`Totale num. Parti: ${b}`);a=a.join("\n");wnds.wpre.show(a)}
async function deleteDati(a){await confirm("Confermi cancellazione dati?")&&(DataMgr.deleteJsonDati(),wnds.wdiv.close(),wnds.wpre.close(),TextOutput.clear())}async function deleteStorage(a){await confirm("Confermi cancellazione documenti & dati?")&&(DataMgr.deleteJsonDati(),localStorage.clear(),wnds.wdiv.close(),wnds.wpre.close(),TextOutput.clear(),DataMgr.docs=[],DataMgr.doc_names=[])}async function help1(a){a=await requestGet("./data/help_test.html");wnds.wdiv.show(a)}
function loadTestoEsempio(a){DataMgr.loadDoc(`data/${a}`);wnds.wdiv.close()}function help2(a){wnds.wdiv.show(help2_html)}const themeKey="theme";function getTheme(){const a=localStorage.getItem(themeKey);a&&"light"==a?(document.body.classList.add("theme-light"),document.documentElement.classList.toggle("invert")):document.body.classList.add("theme-dark")}
function setLight(){document.documentElement.classList.toggle("invert");document.body.classList.remove("theme-dark");document.body.classList.add("theme-light");localStorage.setItem(themeKey,"light")}function setDark(){document.documentElement.classList.toggle("invert");document.body.classList.remove("theme-light");document.body.classList.add("theme-dark");localStorage.setItem(themeKey,"dark")}
function showPrompts(a){if(0!=Rag.prompts.length){for(const b of Rag.prompts)console.log(b);a=Rag.prompts.map((b,c)=>`[${c+1}]${b}\n`).join("\n");wnds.wpre.show(a)}};class LLMClient{constructor(a,b=""){if(this.constructor===LLMClient)throw Error("LLMClient is an abstract class and cannot be instantiated directly.");this.apiKey=a;this.baseUrl=b;this.abortController=null;this.isCancelled=!1}async sendRequest(a,b){throw Error("Method 'sendRequest()' must be implemented.");}cancelRequest(){this.isCancelled=!0;return this.abortController?(this.abortController.abort(),this.abortController=null,!0):!1}_createResult(a,b=null,c=null,d=null){return{ok:a,response:b,data:c,
error:d}}_createError(a,b,c,d){return{message:a||null,type:b||null,code:c||null,details:{message:d?.message||null,type:d?.type||null,param:d?.param||null,code:d?.code||null}}}async _handleHttpError(a){let b,c="HTTPError",d={400:"Richiesta non valida",401:"Non autorizzato - Controlla la API key",403:"Accesso negato",404:"Endpoint non trovato",429:"Troppe richieste - Rate limit superato",500:"Errore interno del server",503:"Servizio non disponibile"}[a.status]||`Errore HTTP ${a.status}`;try{if(a.headers.get("Content-Type")?.includes("application/json")){if(b=
await a.json(),400===a.status&&b){const e="string"===typeof b.error?b.error:b.message||b.error?.message;e&&(e.includes("token limit")||e.includes("token exceeded")||e.includes("input too long")||e.includes("context length")||e.includes("max tokens"))&&(d="Input troppo lungo - Superato il limite di token",c="TokenLimitError")}}else b=await a.text(),400===a.status&&(b.includes("token limit")||b.includes("input too long")||b.includes("context length"))&&(d="Input troppo lungo - Superato il limite di token",
c="TokenLimitError")}catch(e){b={message:"Impossibile estrarre i dettagli dell'errore"}}return this._createError(d,c,a.status,"string"===typeof b?{message:b}:b)}_handleNetworkError(a){return"AbortError"===a.name?this.isCancelled?this._createError("Richiesta annullata dall'utente","CancellationError",499,{message:"La richiesta \u00e8 stata interrotta volontariamente dall'utente"}):this._createError("Richiesta interrotta per timeout","TimeoutError",408,{message:"La richiesta \u00e8 stata interrotta a causa di un timeout",
isTimeout:!0}):"TypeError"===a.name&&a.message.includes("Failed to fetch")?this._createError("Errore di rete","NetworkError",0,{message:"Impossibile raggiungere il server. Controlla la connessione."}):this._createError("Errore imprevisto",a.name||"UnknownError",500,{message:a.message||"Si \u00e8 verificato un errore sconosciuto"})}async _fetch(a,b,c,d=60){this.isCancelled=!1;this.abortController=new AbortController;const e=this.abortController.signal;d=setTimeout(()=>{this.abortController&&this.abortController.abort()},
1E3*d);try{const f=await fetch(a,{method:"POST",headers:c,body:JSON.stringify(b),signal:e});clearTimeout(d);if(this.isCancelled){const k=this._createError("Richiesta annullata","CancellationError",499,{message:"La richiesta \u00e8 stata interrotta volontariamente dall'utente"});return this._createResult(!1,null,null,k)}if(!f.ok){const k=await this._handleHttpError(f);return this._createResult(!1,null,null,k)}const g=await f.json();return this._createResult(!0,g)}catch(f){clearTimeout(d);const g=this._handleNetworkError(f);
return this._createResult(!1,null,null,g)}finally{this.abortController=null}}}function getLlmClient(a){console.log("** MODEL:\n",a);return a.toLowerCase().includes("gemini")?new GeminiClient("AIzaSyAMbjL5tbVKPtNWwQEr8ozQvM_jvSkNCJc"):new MistralClient("FAUsMsVFSw5gW5OEkvUZEZ1jcIWFlPj4")};class GeminiClient extends LLMClient{constructor(a){super(a,"https://generativelanguage.googleapis.com/v1beta/models/")}async sendRequest(a,b=60){const c=`${this.baseUrl}${a.model||"gemini-1.5-flash"}:generateContent?key=${this.apiKey}`;a=this._convertPayloadToGemini(a);b=await this._fetch(c,a,{"Content-Type":"application/json"},b);if(b.ok)try{return this._createResult(!0,b.response,b.response.candidates[0].content.parts[0].text)}catch(d){return this._createResult(!1,null,null,this._createError("Invalid response structure",
"ParsingError",null,d))}else return b}_convertPayloadToGemini(a){return{contents:a.messages.map(b=>({role:"system"===b.role?"user":b.role,parts:[{text:b.content}]})),generationConfig:{temperature:a.temperature,maxOutputTokens:a.max_tokens}}}};const help0_html='\n<div class="text">\n    <p class="center"> Comandi barra superiore </p>\n    <div>\n        Pulsante Menu\n        <p> Apre/chiude il Menu comandi </p>\n    </div>\n    <div>\n        Upload Files\n        <p>\n            Fa l\'upload di un file locale. Sono accettati i file pdf, docx e txt.\n            Controlla se il file \u00e8 in archivio, per non sovrascriverlo.\n        </p>\n    </div>\n    <div>\n        Upload Dir:\n        <p>\n            Per fare l\'upload dei files di una directory. Sono accettati i files pdf, docx e txt.\n            I file in archivio con lo stesso nome non vengono sovrascritti.\n        </p>\n    </div>\n    <div>\n        Log:\n        <p>\n            Attiva/Disattiva la visualizzazione del Log.\n            Nel Log sono visualizzate le query con le dimensioni delle parti di documento analizzate.\n        </p>\n    </div>\n\n    \x3c!--  --\x3e\n    <hr>\n    \x3c!--  --\x3e\n    <div>\n        <p class="center"> Comandi lato destro in alto: </p>\n    </div>\n    <div>\n        Copia Output:\n        <p> Copia il testo dell\'output negli appunti. </p>\n    </div>\n    <div>\n        Apri Output:\n        <p> Visualizza il testo in una finestra pi\u00f9 grande. </p>\n    </div>\n    <hr>\n    \x3c!--  --\x3e\n    <div>\n        <p class="center"> Comandi lato destro in basso: </p>\n    </div>\n    <div>\n        Documenti => RAG => Contesto => Query: (Pulsante Rosso)\n        <p>\n            Input per la query da utilizzare per la elaborazione RAG.\n            <br>\n            Ogni documento in archivio \u00e8 diviso in parti compatibili con l\'ampiezza della finestra\n            di input del Model utilizzato.\n        </p>\n        <p>\n            Per ogni parte esegue una query utilizzandola per estrarre informazioni/concetti pertinenti alla stessa.\n        </p>\n        <p>\n            Il risultato di ogni query \u00e8 archiviato nella memoria locale.\n        </p>\n        <p>\n            Alla fine della sequenza di elaborazioni esegue una query che produce\n            un contesto riepilogativo delle risposte archiviate.\n        </p>\n        <p>\n            Infine esegue la query utilizzando il contesto creato e visualizza la risposta nella finestra di output.\n        </p>\n    </div>\n    <div>\n        Contesto => Query: (Pulsante Verde / Invio)\n        <p>\n            Input per query che utilizzano il contesto creato con l\'elaborazione RAG.\n            Il contesto RAG pu\u00f2 essere vuoto.\n            Inizia una conversazione.\n        </p>\n        <p>\n            La conversazione ha senso relativamente all\'elaborazione RAG se ogni query \u00e8 una variazione / approfondimento della query iniziale.\n        </p>\n    </div>\n    <div>\n        Cancella Conversazione:\n        <p>\n            Cancella la storia della conversazione attiva.\n            Non vengono cancellati i dati dell\'elaborazione RAG\n        </p>\n        Per andare a capo: Maiusc. + Invio\n    </div>\n    \x3c!--  --\x3e\n    <hr>\n    \x3c!--  --\x3e\n    <div>\n        <p class=" center"> Comandi del Menu: </p>\n    </div>\n    <div>\n        README\n        <p>\n            Presenta una spiegazione della implementazione della\n            tecnologia RAG utilizzata.\n        </p>\n    </div>\n    <div>\n        Risposta Contestuale:\n        <p> Visualizza la risposta ottenuta alla fine della elaborazione RAG </p>\n    </div>\n    <div>\n        Domanda iniziale:\n        <p> Visualizza la query utilizzata per l\'elaborazione RAG </p>\n    </div>\n    <div>\n        Elenco Risposte:\n        <p>\n            Visualizza l\'elenco delle risposte per ogni parte documento utilizzata fino alla risposta che genera il contesto.\n        </p>\n    </div>\n    <div>\n        Contesto RAG:\n        <p>\n            Visualizza il contesto creato utilizzando le risposte elaborate.\n        </p>\n    </div>\n    <div>\n        Dati Archiviati:\n        <p>\n            Visualizza i dati in archivio e le loro dimensioni:\n        </p>\n    </div>\n    <div>\n        Elenco Documenti:\n        <p>\n            Visualizza la lista dei documenti archiviati ed utilizzabili per l\'elaborazione.<br>\n            Con il clic del mouse sul nome di un documento si visualizza.\n        </p>\n    </div>\n\n    <div>\n        Numero query:\n        <p>\n            Calcola le query necessarie per ogni documento e le Query totali,\n            necessarie per analizzare tutti i documenti caricati.\n        </p>\n    </div>\n\n    <div>\n        Cancella Dati:\n        <p>\n            Cancella i dati delle elaborazioni salvati nell\'archivio.\n            NON cancella i documenti caricati.\n        </p>\n    </div>\n\n    <div>\n        Cancella Documenti:\n        <p>\n            Cancella i documenti caricati e tutti i dati archiviati localmente.\n        </p>\n    </div>\n\n    \x3c!--  --\x3e\n\n    <p class="center">Sequenza Comandi Interrogazione -Conversazione</p>\n    <div>\n        Archivia nella memoria locale uno o pi\u00f9 documenti:\n        <p>\n            Utilizza i dati di esempio per le prime prove.\n            Utilizza upload file o upload dir per i documenti da leggere dal tuo computer.\n        </p>\n    </div>\n    <div>\n        Digita una query che si riferisca ai documenti archiviati.\n        <p>\n            La query sar\u00e0 utilizzata come criterio di selezione di informazioni dai documenti archiviati.\n        </p>\n    </div>\n\n    <div>\n        Click sul bottone rosso in basso a destra. Documento => RAG => Contesto => Query\n        <p>\n            Viene lanciata una sequenza di elaborazione per analizzare i documenti sulla base della query.\n            Se il log \u00e8 attivo vedrai la sequenza di elaborazione.\n            <br>\n            Il loro numero dipende dalle dimensioni dei documenti.\n            <br>\n            l menu puoi utilizzare il comando "Num Query" per vedere quante elaborazioni saranno fatte per ogni documento.\n            <br>\n            Alla fine del processo sar\u00e0 visualizzata la risposta.\n        </p>\n    </div>\n\n    <div>\n        Click sul bottone verde in basso a destra (oppure Invio). Contesto => Query\n        <p>\n            Inizia una conversazione utilizzando le informazioni precedentemente raccolte dai documenti.\n            Puoi inviare domande successive di approfondimento e chiarimento.\n            <br>\n            \u00c8 FONDAMENTALE che le query siano approfondimenti e/o chiarimenti della query iniziale.\n            In caso contrario non si sfrutta il Contesto creato dall\'elaborazione precedente.\n            <br>\n            Quindi per una query completamente nuova (sempre relativa ai documenti archiviati) \u00e8 necessario iniziare una nuova elaborazione.\n            <br>\n            Il comando cancella, oltre a cancellare il campo di input cancella anche la sequenza query-risposte della\n            conversazione.\n            <br>\n            NON cancella i dati dell\'elaborazione iniziale.\n        </p>\n    </div>\n</div>\n',
help1_html="\n<div class=\"text\">\n    <pre>\nUn'implementazione innovativa della tecnica RAG per il Question Answering\nLa tecnica RAG (Retrieval-Augmented Generation) \u00e8 un approccio consolidato nel campo del question answering e della generazione di testo, che combina il recupero di informazioni pertinenti da fonti di dati con la generazione di testo basata su queste informazioni.\nQui viene proposta un'implementazione che introduce una variazione a questo paradigma.\nL'implementazione si basa su una sequenza di prompt appositamente progettati per guidare un modello di linguaggio generativo attraverso le diverse fasi della tecnica RAG.\nQuesti prompt forniscono istruzioni dettagliate su come il modello deve seguire operazioni di recupero di informazioni, aumento delle informazioni recuperate e infine generazione di una risposta finale.\nLa risposta finale diviene poi il contesto da inserire nel prompt per rispondere alla domanda.\nUn aspetto cruciale di questa implementazione \u00e8 che lo stesso modello di linguaggio generativo svolge tutte le operazioni richieste, dall'analisi dei documenti di input al recupero di informazioni rilevanti, alla generazione della risposta finale.\nQuesta caratteristica rappresenta una deviazione significativa rispetto alle implementazioni standard della tecnica RAG, che prevedono l'utilizzo di moduli distinti per il recupero e la generazione.\nLa sequenza di prompt proposta guida il modello attraverso le seguenti fasi:\n\n1. Retrieval: Il modello analizza il documento di input e la domanda fornita, identificando e recuperando le informazioni e i concetti rilevanti per dare seguito alla domanda.\n\n2. Augmentation: Successivamente, il modello integra le informazioni recuperate con eventuali risposte accumulate in precedenza, estraendo nuove informazioni rilevanti e organizzandole in un elenco coerente, evitando ridondanze.\n\n3. Generation: Infine, il modello utilizza l'insieme di informazioni rilevanti e non ridondanti per generare una risposta completa e concisa alla domanda dell'utente.\n\nQuesta implementazione offre diversi vantaggi.\nIn primo luogo, sfrutta le capacit\u00e0 di un unico modello di grandi dimensioni, evitando la necessit\u00e0 di moduli distinti specializzati per ogni fase.\nInoltre, l'utilizzo di prompt espliciti pu\u00f2 migliorare la controllabilit\u00e0 e la trasparenza del processo, consentendo di guidare il modello in modo pi\u00f9 diretto.\nNaturalmente, come per qualsiasi approccio basato su modelli di linguaggio generativi, \u00e8 fondamentale prestare attenzione alle questioni di affidabilit\u00e0, correttezza e bias dei dati di addestramento.\nRispetto a un'implementazione standard di RAG vi \u00e8 la necessit\u00e0 di rilanciare l'elaborazione ad ogni domanda radicalmente nuova in quanto il contesto creato con le informazioni estratte dai documenti \u00e8 definito sulla base della domanda.\nInvece nella versione standard RAG si usano gli incorporamenti delle informazioni estratte dai documenti in modo tale che tali informazioni vengono viste quasi come un'estensione del modello e possono essere usate per domande diverse.\nQuindi dal punto di vista utente le implementazioni RAG standard sono pi\u00f9 efficienti; infatti l'implementazione proposta richiede per ogni nuova domanda una sequenza di richieste che saranno utilizzabili solo per creare il contesto per la domanda iniziale e per una conversazione con domande simili.\nIl vantaggio dell'implementazione proposta consiste nel fatto che pu\u00f2 essere implementata completamente lato client senza bisogno di sviluppare alcun modulo sul server.\nL\u2019unica cosa che serve \u00e8 un servizio serverless come quello di HuggingFace o simile.\nQuindi rappresenta un'interessante prospettiva sull'applicazione della tecnica RAG in modo pi\u00f9 integrato e controllato attraverso l'uso di prompt mirati.\nIn conclusione, questa implementazione della tecnica RAG dimostra come le capacit\u00e0 dei modelli di linguaggio generativi di grandi dimensioni possano essere sfruttate in modi nuovi e creativi, potenzialmente aprendo la strada a ulteriori sviluppi nel campo del question answering e della generazione di testo.\n\nQuesta \u00e8 la valutazione fatta da un LLM (comprensivo e gentile)\n\nLa mia valutazione personale della tua proposta di implementazione della tecnica RAG, con un elenco di pro e contro:\n\nPunti a favore (Pro):\nSemplificazione del processo: L'utilizzo di un unico modello di grandi dimensioni addestrato su vasti corpus di dati semplifica notevolmente l'architettura complessiva rispetto alle implementazioni tradizionali della tecnica RAG, che spesso prevedono moduli distinti per il recupero e la generazione.\n\nCapacit\u00e0 di adattamento e apprendimento: I modelli di linguaggio generativi di grandi dimensioni sono noti per la loro capacit\u00e0 di adattarsi e imparare da nuovi dati e istruzioni.\nQuesto potrebbe consentire di raffinare e migliorare l'implementazione nel corso del tempo.\n\nControllo e trasparenza: L'utilizzo di prompt espliciti per guidare il modello attraverso le diverse fasi del processo pu\u00f2 migliorare la controllabilit\u00e0 e la trasparenza, consentendo di monitorare e regolare il comportamento del modello in modo pi\u00f9 diretto.\n\nEfficienza computazionale: Avere un'unica architettura integrata potrebbe comportare vantaggi in termini di efficienza computazionale rispetto a soluzioni che prevedono moduli separati.\n\nPunti a sfavore (Contro):\n\nAffidabilit\u00e0 e coerenza: Poich\u00e9 un unico modello gestisce tutte le fasi, eventuali errori o incoerenze potrebbero propagarsi e amplificarsi attraverso l'intero processo, influenzando la qualit\u00e0 della risposta finale.\n\nBias dei dati di addestramento: Come per qualsiasi modello di linguaggio generativo, l\u2019approccio potrebbe essere influenzato dai bias presenti nei dati di addestramento utilizzati, con potenziali impatti sulla correttezza e l'equit\u00e0 delle risposte generate.\n\nMancanza di specializzazione: Mentre i modelli di grandi dimensioni sono versatili, potrebbero non essere ottimizzati per compiti specifici come il recupero di informazioni o la generazione di risposte rispetto a moduli specializzati.\n\nDifficolt\u00e0 di debug e interpretabilit\u00e0: Con un'architettura integrata e basata su prompt, potrebbe essere pi\u00f9 complesso eseguire il debug e comprendere le ragioni dietro a eventuali errori o comportamenti indesiderati del modello.\n\nIn sintesi, la proposta presenta alcuni vantaggi interessanti in termini di semplificazione, adattabilit\u00e0 e controllo, ma solleva anche potenziali preoccupazioni riguardo all'affidabilit\u00e0, ai bias, alla mancanza di specializzazione e alle difficolt\u00e0 di debug e interpretabilit\u00e0.\nCome per qualsiasi nuovo approccio, sarebbe necessario valutarlo attentamente attraverso sperimentazioni e test approfonditi per determinare l'efficacia e l'applicabilit\u00e0 in contesti specifici.\n    </pre>\n</div>\n",
help2_html='\n<div class="text">\n    <pre class="pre-text">\nNella redazione della domanda bisogna tenere conto del fatto che la domanda viene poi inserita in un prompt nel quale si fa esplicita richiesta di utilizzare il documento fornito.\nQuindi \u00e8 implicito il riferimento al/ai documenti archiviati.\nTuttavia, quando si tratta di documenti il cui contenuto \u00e8 sicuramente disponibile su internet, pu\u00f2 essere opportuno esplicitare nella domanda che ci si riferisce ai documenti forniti.\n</pre>\n    <p class="center">Esempi di domande</p>\n    <div>\n        <p>Fai una relazione sul documento che ti ho fornito.</p>\n        <p>Approfondisci la tesi sostenuta nei documenti.</p>\n        <p>Confronta i diversi punti di vista espressi dagli autori.</p>\n        <p>Descrivi la personalit\u00e0 dei protagonisti.</p>\n        <p>Analizza il documento che ti ho fornito e illustrami eventuali contraddizioni.</p>\n        <p>Illustra i momenti salienti del racconto.</p>\n        <p>Analizzando il documento che ti ho fornito, confronta le tesi di ... con quelle di ...</p>\n        <p>Qual \u00e8 l\'avvenimento pi\u00f9 importante?</p>\n    </div>\n</div>\n';class MistralClient extends LLMClient{constructor(a){super(a,"https://api.mistral.ai/v1/chat/completions")}async sendRequest(a,b=60){a=await this._fetch(this.baseUrl,a,{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},b);if(a.ok)try{return this._createResult(!0,a.response,a.response.choices[0].message.content)}catch(c){return this._createResult(!1,null,null,this._createError("Invalid response structure","ParsingError",null,c))}else return a}};function removeTag(a){a=a.replace(/<<</g,"").replace(/>>>/g,"");return a=a.replace(/<</g,"").replace(/>>/g,"")}
function cleanDoc(a){try{return a=a.replace(/`/g,""),a=removeTag(a),a=a.replace(/(\w+)-\s*\n(\w+)/g,"$1$2"),a=a.replace(/[\u00AD\u200B\u200C\u200D\u2060\uFEFF\u0008]/g,""),a=a.replace(/[\u00A0\u2000-\u200A\u202F\u205F\u3000\t\r\f\v]/g," "),a=a.replace(/\\([nrtfb])/g,"$1"),a=a.replace(/\\(u[0-9a-fA-F]{4}|x[0-9a-fA-F]{2})/g,"$1"),a=a.replace(/\\([a-zA-Z]:\\|\\\\[a-zA-Z0-9_]+\\)/g,"\\$1"),a=a.replace(/\\/g,""),a=a.replace(/(.)\1{3,}/g,""),a=a.replace(/\u201c/g,'"').replace(/\u201d/g,'"'),a=a.replace(/\n/g,
" "),a=a.replace(/ +([.,;:!?])/g,"$1"),a=a.replace(/ +/g," "),a.trim()}catch(b){return console.error(b),"Errore di codifica del documento"}}
function cleanResponse(a){try{return a=a.replace(/[\u00AD\u200B\u200C\u200D\u2060\uFEFF]/g,""),a=a.replace(/[\u00A0\u2000-\u200A\u202F\u205F\u3000\t\r\f\v]/g," "),a=a.replace(/\\([nrtfb])/g,"$1"),a=a.replace(/\\(u[0-9a-fA-F]{4}|x[0-9a-fA-F]{2})/g,"$1"),a=a.replace(/\\([a-zA-Z]:\\|\\\\[a-zA-Z0-9_]+\\)/g,"\\\\$1"),a=a.replace(/\\/g,""),a=a.replace(/\n{2,}/g,"\n"),a=a.replace(/ +/g," "),a.trim()}catch(b){return console.error(b),`Errore di codifica nella risposta\n${b}`}}
function messages2html(a){lst=[];for(const b of a){a=b.role;let c=b.content.replace(/\n{2,}/g,"\n");"assistant"==a?(c=c.replace(/\./g,".\n").replace(/\n{2,}/g,"\n"),a=`<div class="assistant"><b>Assistant:</b><br>${c}</div>`):"user"==a?a=`<div class="user"><b>User:</b><br>${c}</div>`:"system"==a?a=`<div class="system"><b>System:</b><br>${c}</div>`:(alert("ERROR  in role"),a="<div>ERRROR ROLE</div>");lst.push(a)}return lst.join("\n")}
function messages2text(a){lst=[];for(const b of a){a=b.role;const c=b.content.trim();"assistant"==a?a=`Assistant:\n${c}\n`:"user"==a?a=`User:\n${c}`:"system"==a?a=`System:\n${c}`:(alert("ERROR  in role"),a="ERRROR ROLE");lst.push(a)}return lst.join("\n")}
function textFormatter(a){a=a.replace(/<[^>]*>/g,"").split(/([.!?:])(?=\s|$)/);let b="";for(let c=0;c<a.length;c+=2){let d=a[c],e=a[c+1]||"";0<d.trim().length&&(b+="  "+d.trim()+e);c<a.length-2&&(b+="\n")}b=b.replace(/User:/g,"\n\nUSER:\n");b=b.replace(/Assistant:/g,"\n\nASSISTANT:\n");return b.trim()};const UaDb={create(a,b){localStorage.getItem(a)?console.error(`ID ${a} already exists.`):localStorage.setItem(a,b)},read(a){const b=localStorage.getItem(a);return null===b?(xlog(`UaDb.read  ${a} not found.`),""):b},update(a,b){localStorage.getItem(a)?localStorage.setItem(a,b):xlog(`UaDb.update ${a} not found.`)},delete(a){localStorage.getItem(a)?localStorage.removeItem(a):console.error(`ID ${a} not found.`)},save(a,b){localStorage.setItem(a,b)},getAllIds(){const a=[];for(let b=0;b<localStorage.length;b++)a.push(localStorage.key(b));
return a},saveArray(a,b){b=JSON.stringify(b);UaDb.save(a,b)},readArray(a){a=UaDb.read(a);return 0==a.trim().length?[]:JSON.parse(a)},saveJson(a,b){b=JSON.stringify(b);UaDb.save(a,b)},readJson(a){return(a=UaDb.read(a))?JSON.parse(a):{}}},DataMgr={docs:[],doc_names:[],linkToName(a){a=a.split("/");return a[a.length-1]},async loadDoc(a){this.readDbDocNames();try{const b=await requestGet(a),c=cleanDoc(b),d=this.linkToName(a);if(this.doc_names.includes(d))alert(`Il documento ${d} \u00e8 gi\u00e0 caricato`);
else return this.doc_names.push(d),this.docs.push(c),this.saveDbDocs(),c}catch(b){alert("loadDoc()\n"+b+"\n"+a)}},addDoc(a,b){b=cleanDoc(b);this.docs.push(b);this.doc_names.push(a);this.saveDbDocs()},saveDbDocs(){UaDb.saveArray(ID_DOC_NAMES,this.doc_names);UaDb.saveArray(ID_DOCS,this.docs)},readDbDocs(){this.docs=UaDb.readArray(ID_DOCS)},readDbDocNames(){return this.doc_names=UaDb.readArray(ID_DOC_NAMES)},deleteJsonDati(){const a=UaDb.getAllIds();for(const b of a)[ID_DOCS,ID_DOC_NAMES].includes(b)||
UaDb.delete(b);Rag.ragQuery="";Rag.ragContext="";Rag.ragAnswer="";Rag.answers=[];Rag.prompts=[];ThreadMgr.rows=[]}};async function requestGet(a){try{var b=await fetch(a,{method:"GET",headers:{"Content-Type":"text/plain;charset=UTF-8"}});if(!b.ok)throw Error(`HTTP error! status: ${b.status}`);const c=await b.arrayBuffer();return(new TextDecoder("utf-8")).decode(c)}catch(c){throw console.error(`Error in requestGet() for url: ${a}`,c),b=c.message.includes("HTTP error! status")?c.message:c.message.includes("NetworkError")?"Network error occurred":"An unknown error occurred",alert(`requestGet()\nurl: ${a}\n${b}`),c;
}}function loadScript(a,b){const c=document.createElement("script");c.src=a;c.onload=()=>{b();document.head.removeChild(c)};c.onerror=()=>{alert(`Errore: Impossibile caricare lo script ${a}`)};document.head.appendChild(c)};const ID_RAG="id_rag",ID_THREAD="id_thread",ID_RESPONSES="id_responses",ID_DOC_NAMES="id_doc_names",ID_DOCS="id_docs",PROMPT_DECR=10240,maxLenRequest=(a=32)=>{a*=3072;return Math.trunc(a+.1*a)},MAX_PROMPT_LENGTH=maxLenRequest(200),MODEL="gemini-2.0-flash",client=getLlmClient(MODEL),responseDetails={set(a){this.response=a},get_total_tokens(){return 0},get_completion_tokens(){return this.response.usage.completion_tokens}},calcTokens={sum_input_tokens:0,sum_generate_tokens:0,init(){this.sum_generate_tokens=
this.sum_input_tokens=0},add(a){a&&(this.sum_input_tokens+=0)},get_sum_input_tokens(){return this.sum_input_tokens},get_sum_generate_tokens(){return this.sum_generate_tokens}},showTokens=a=>{let b=calcTokens.get_sum_input_tokens(),c=calcTokens.get_sum_generate_tokens();console.log(`Sum Tokens: ${b} ${c}`);responseDetails.set(a)};function cancelClientRequest(){client.cancelRequest()}
const getPromptTokens=a=>(a=a.details.message.match(/Prompt contains (\d+) tokens/))?parseInt(a[1],10):null,getModelToken=a=>(a=a.details.message.match(/model with (\d+) maximum context length/))?parseInt(a[1],10):null,isTooLarge=a=>a.details.message.includes("too large"),truncateInput=(a,b)=>a.substring(0,a.length-b),getPartSize=(a,b,c)=>{c=MAX_PROMPT_LENGTH-c;a.length+b.length<c?c=a.length:(a=a.indexOf(".",c),a=(-1!==a?a:c)+1,a>c+100&&(a=c),c=a);return c},getPartDoc=(a,b)=>{const c=a.substring(0,
b);a=a.substring(b).trim();return[c,a]},ragLog=(a,b,c,d)=>{const e=MAX_PROMPT_LENGTH;d=d.reduce((f,g)=>f+g.length,0);xlog(`${a} mx:${e} lft:${b} rgt:${c} arr:${d}`);a=formatRow([a,b,c,d],[8,-7,-7,-7]);UaLog.log(a)},Rag={ragContext:"",ragQuery:"",ragAnswer:"",answers:[],docContextLst:[],init(){ThreadMgr.initThread();this.readRespsFromDb();this.readFromDb();calcTokens.init()},returnOk(){return 10<this.ragContext.length},saveToDb(){UaDb.saveJson(ID_RAG,{context:this.ragContext,ragquery:this.ragQuery,
raganswer:this.ragAnswer});UaDb.saveArray(ID_THREAD,ThreadMgr.rows)},readFromDb(){const a=UaDb.readJson(ID_RAG);this.ragContext=a.context||"";this.ragQuery=a.ragquery||"";this.ragAnswer=a.raganswer||"";ThreadMgr.rows=UaDb.readArray(ID_THREAD)},saveRespToDb(){UaDb.saveArray(ID_RESPONSES,this.answers)},readRespsFromDb(){this.answers=UaDb.readArray(ID_RESPONSES)},addPrompt(a){},async requestDocsRAG(a){DataMgr.deleteJsonDati();DataMgr.readDbDocNames();DataMgr.readDbDocs();this.docContextLst=[];this.ragQuery=
a;ThreadMgr.initThread();this.saveToDb();var b=0;try{let e=1;for(let f=0;f<DataMgr.docs.length;f++){let g=DataMgr.docs[f];if(""==g.trim())continue;const k=DataMgr.doc_names[f],h=g.length;xlog(`${k} (${h}) `);UaLog.log(`${k} (${h}) `);++b;var c=1;let l=0,t="",u="",q="",v=[];for(;;){const r=getPartSize(g,promptDoc("",a,""),l);if(10>r)break;[t,u]=getPartDoc(g,r);ragLog(`${e}) ${b},${c}`,t.length,u.length,this.answers);const w=promptDoc(t,this.ragquery),p=getPayloadDoc(MODEL,w),m=await client.sendRequest(p,
90);if(!m)return"";const n=m.error;if(!m.ok){console.error("ERR1\n",n);const y=n.code;if(400==y)if(isTooLarge(n)){UaLog.log(`Error tokens Doc ${prompt.length}`);l+=PROMPT_DECR;continue}else throw n;else if(408==y){UaLog.log("Error timeout Context");continue}else throw n;}q=m.data;if(!q)return"";const z=m.response;showTokens(z);calcTokens.add(z);c++;e++;g=u;q=cleanResponse(q);v.push(q);this.answers.push(`DOCUMENTO : ${k}_${c}\n${q}`)}const A=v.length;let x=v.join("\n\n");for(c="";;){const r=promptBuildContext(x,
this.ragQuery),w=getPayloadBuildContext(MODEL,r),p=await client.sendRequest(w,90);if(!p)return"";const m=p.error;if(!p.ok){console.error("ERR2\n",m);const n=m.code;if(400==n)if(isTooLarge(m)){UaLog.log(`Error tokens build Context ${prompt.length}`);x=truncateInput(x,PROMPT_DECR);continue}else throw m;else if(408==n){UaLog.log("Error timeout Context");continue}else throw m;}c=p.data;if(!c)return"";calcTokens.add(p.response);break}UaLog.log(`context  ${A} => ${c.length}`);c=`\n### DOCUMENTO: ${k}\n ${c}`;
this.docContextLst.push(c)}}catch(e){throw console.error("ERR3\n",e),e;}this.ragContext=this.docContextLst.join("\n\n");this.saveToDb();a="";b=this.ragContext;try{for(;;){const f=promptWithContext(b,this.ragQuery),g=getPayloadWithContext(MODEL,f),k=await client.sendRequest(g,90);if(!k)return"";const h=k.error;if(!k.ok){console.error("ERR4\n",h);const l=h.code;if(400==l)if(isTooLarge(h)){UaLog.log(`Error tokens with Context ${f.length}`);b=truncateInput(b,PROMPT_DECR);continue}else throw h;else if(408==
l){UaLog.log("Error timeout Context");continue}else throw h;}a=k.data;if(!a)return"";calcTokens.add(k.response);break}this.ragAnswer=a=cleanResponse(a);this.saveRespToDb();this.saveToDb();UaLog.log(`Risposta: (${this.ragAnswer.length})`);var d=calcTokens.get_sum_input_tokens();const e=calcTokens.get_sum_generate_tokens();UaLog.log(`Tokens: ${d} ${e}`);d=[];d.push({role:"user",content:this.ragQuery});d.push({role:"assistant",content:a});return messages2html(d)}catch(e){throw console.error("ERR5\n",
e),e;}},async requestContext(a){let b="";ThreadMgr.isFirst()?(console.log("******** FIRST"),this.ragContext?(a=promptThreadRag(this.ragContext,this.ragQuery,this.ragAnswer,a),ThreadMgr.addMessages(a)):(a=promptThread(a),ThreadMgr.addMessages(a))):(console.log("******** NEXT"),ThreadMgr.addQuery(a));try{const c=ThreadMgr.getMessages(),d=getPayloadThread(MODEL,c);for(;;){const g=await client.sendRequest(d,90);if(!g)return"";const k=g.error;if(!g.ok){console.error("ERR6\n",k);const l=k.code;if(400==
l)throw isTooLarge(k)&&alert("Conversazione troppo lunga"),k;if(408==l)continue;else throw k;}b=g.data;if(!b)return"";const h=g.response;showTokens(h);calcTokens.add(h);break}b=cleanResponse(b);ThreadMgr.addAnswer(b);const e=ThreadMgr.getUserMessages(),f=messages2html(e);UaLog.log(`Inizio Conversazione (${prompt.length})`);return f}catch(c){throw console.error("ERR7\n",c),c;}}},ThreadMgr={rows:[],initThread(){this.rows=[]},delete(){alert("DELETE");this.rows=[]},addMessages(a){for(const b of a)this.rows.push(b);
UaDb.saveArray(ID_THREAD,ThreadMgr.rows)},getMessages(){return this.rows},getUserMessages(){return this.rows.filter((a,b)=>"system"!==a.role)},addQuery(a){this.addMessages([{role:"user",content:a}])},addAnswer(a){this.addMessages([{role:"assistant",content:a}])},isFirst(){return 1>this.rows.length}};function getPayloadDoc(a,b){return{model:a,temperature:.3,max_tokens:1024,stream:!1,random_seed:42,messages:b,safe_prompt:!1}}function getPayloadBuildContext(a,b){return{model:a,messages:b,temperature:.3,max_tokens:2E3,stream:!1,safe_prompt:!1,random_seed:42}}function getPayloadWithContext(a,b){return{model:a,messages:b,temperature:.3,max_tokens:2E3,stream:!1,safe_prompt:!1,random_seed:42}}
function getPayloadThread(a,b){return{model:a,messages:b,temperature:.7,max_tokens:2E3,stream:!1,safe_prompt:!1,random_seed:42}};function promptDoc(a,b){return[{role:"system",content:"Estrattore semantico di informazioni ottimizzato per elaborazione da un LLM.\n\n# OBIETTIVO\nEstrarre e condensare le informazioni essenziali dal TESTO per rispondere alla DOMANDA, in formato ottimizzato per elaborazione computazionale.\n\n# ISTRUZIONI\n1. Analizza il testo e seleziona SOLO le informazioni direttamente rilevanti per la domanda.\n2. Elimina contenuti irrilevanti o ridondanti.\n3. Mantieni relazioni logiche essenziali (causali, temporali, concettuali).\n4. Preserva terminologia specialistica necessaria.\n5. Produci proposizioni atomiche semanticamente complete.\n6. Usa sintassi minimale (soggetto-verbo-complemento).\n7. Elimina elementi discorsivi, connettivi e contestualizzazioni non essenziali.\n8. Presenta l'informazione con massima densit\u00e0 semantica, senza ridondanze.\n\n# FORMATO\n- Struttura flat senza gerarchie\n- Non numerare le proposizioni.\n- Non usare introduzioni o conclusioni.\n- Non includere spiegazioni meta-testuali.\n- Non inserire frasi di collegamento tra le proposizioni.\n"},
{role:"user",content:`# TESTO:
${a}

# DOMANDA
${b}

Procedi con l'estrazione semantica seguendo le istruzioni fornite.
`}]}
function promptBuildContext(a,b=""){return[{role:"system",content:"Estrattore e compattatore semantico per contesto LLM.\n# OBIETTIVO\nRaggruppa e compatta le informazioni estratte dai frammenti di un documento, associando concetti semanticamente simili e sviluppando inferenze tra le informazioni.\n\n# ISTRUZIONI\n1. Identificazione dei Concetti: Identifica e unifica i concetti che hanno lo stesso significato semantico, anche se espressi in modi diversi\n2. Eliminazione delle Ripetizioni: Elimina le ripetizioni informative mantenendo solo la formulazione pi\u00f9 completa o precisa\n3. Preservazione delle Relazioni Logiche: Mantieni le relazioni logiche essenziali (causali, temporali, concettuali) tra le informazioni\n4. Terminologia Tecnica: Preserva la terminologia tecnica necessaria per mantenere la precisione delle informazioni\n5. Sintassi Semplificata: Usa una sintassi minimale (soggetto-verbo-complemento) per chiarezza e concisione\n6. Eliminazione degli Elementi Discorsivi: Rimuovi elementi discorsivi, connettivi e contestualizzazioni non essenziali\n7. Densit\u00e0 Semantica: Presenta l'informazione con la massima densit\u00e0 semantica, evitando ridondanze\n8. Rielaborazione degli Insegnamenti: Rielabora le informazioni per garantire che siano coese e che sviluppino inferenze tra parti diverse del documento\n\n# FORMATO\n- Struttura flat senza gerarchie\n- NON numerare le proposizioni\n- NON usare introduzioni o conclusioni\n- NON includere spiegazioni meta-testuali\n- NON inserire frasi di collegamento tra le proposizioni\n\nQuando ricevi testo frammentato, procedi immediatamente con il raggruppamento e la compattazione seguendo queste istruzioni.\n"},{role:"user",
content:`
# TESTO
${a}

# DOMANDA
${b}

Procedi con l'estrazione semantica seguendo le istruzioni fornite.
`}]}function promptWithContext(a,b){return[{role:"system",content:`Estrattore e compattatore semantico per contesto LLM.

  # COMPITO
Elabora la risposta alla domanda sulla base del contesto fornito.

# ISTRUZIONI
1. Analizza attentamente il CONTESTO e la DOMANDA.
2. Estrai i concetti chiave e formula inferenze ragionevoli basate sulle informazioni disponibili.
3. Inizia la risposta con una breve introduzione che presenta l'argomento e il contesto.
4. Procedi con un'analisi dettagliata delle informazioni rilevanti trovate nel contesto.
5. Assicurati che la risposta sia completa e risponda direttamente alla domanda posta.

# CONTESTO
${a}

# FORMATO
Fornisci la risposta in un formato semplice e lineare suddiviso in paragrafi.
`},{role:"user",content:`${b}`}]}function promptThreadRag(a,b,c,d){return[{role:"system",content:`Sei un assistente AI progettato per gestire conversazioni dinamiche e adattarti a varie richieste.
   
# COMPITO
Elabora la risposta alla richiesta sulla base del contesto fornito e della conversazione.

# ISTRUZIONI
1. Analizza attentamente il contesto, la conversazione precedente e la richiesta.
2. Interpreta l'intento dell'utente senza limitarti a categorie predefinite.
3. Adatta la tua risposta in base all'intento percepito, sia esso una domanda, una richiesta di azione, un'istruzione specifica o altro.
4. Mantieni una stretta coerenza con il contesto della conversazione.
5. Basa la tua risposta sulle informazioni fornite nel contesto e nella conversazione.
6. Evita divagazioni o argomentazioni non direttamente pertinenti alla richiesta o al contesto.
7. Se l'intento non \u00e8 chiaro, chiedi gentilmente chiarimenti invece di fare supposizioni.
8. Sii flessibile: se la richiesta implica un'azione specifica, adattati di conseguenza.
9. Se \u00e8 necessario integrare con conoscenze generali, specifica chiaramente quando lo stai facendo.

# CONTESTO
${a}

# FORMATO
Fornisci la risposta in un formato semplice e lineare suddiviso in paragrafi.
`},{role:"user",content:`${b}`},{role:"assistant",content:`${c}`},{role:"user",content:`${d}`}]}
function promptThread(a){return[{role:"system",content:"Sei un assistente AI progettato per gestire conversazioni dinamiche e adattarti a varie richieste. \nSei disponibile a soddisfare tutte le mi richieste\n\n# COMPITO\nElabora la risposta alla richiesta sulla base della conversazione.\n\n# ISTRUZIONI\n1. Analizza attentamente la conversazione .\n2. Interpreta l'intento dell'utente senza limitarti a categorie predefinite.\n3. Adatta la tua risposta in base all'intento percepito, sia esso una domanda, una richiesta di azione, un'istruzione specifica o altro.\n4. Mantieni una stretta coerenza con la conversazione.\n5. Basa la tua risposta sulle informazioni fornite nella conversazione.\n6. Evita divagazioni o argomentazioni non direttamente pertinenti alla richiesta.\n7. Se l'intento non \u00e8 chiaro, chiedi gentilmente chiarimenti invece di fare supposizioni.\n8. Sii flessibile: se la richiesta implica un'azione specifica, adattati di conseguenza.\n9. Se \u00e8 necessario integrare con conoscenze generali, specifica chiaramente quando lo stai facendo.\n\n# FORMATO\nFornisci la risposta in un formato semplice e lineare suddiviso in paragrafi.\n"},{role:"user",
content:`${a}`}]};/*

 rag_rqs
 Copyright (C) 2024 [Il tuo nome]

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/
const errorDumps=a=>{const b=JSON.stringify(a,null,2);return"{}"==b?`${a}`:b},WndPre=a=>({w:UaWindowAdm.create(a),out:null,show(b){wnds.closeAll();b=`
<div class="window-text">
<div class="btn-wrapper">
<button class="btn-copy tt-left" data-tt="Copia">
<svg class="copy-icon" viewBox="0 0 20 24">
  <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
</svg>
</button>
<button class="btn-close tt-left" data-tt="chiudi" onclick="UaWindowAdm.closeThis(this)">X</button>
</div>
<pre class="pre-text">${b}</pre>
</div>
    `;this.w.drag();this.w.setZ(12);this.w.vw_vh().setXY(16.5,10,-1);this.w.setHtml(b);this.w.show();this.w.getElement().querySelector(".btn-copy").addEventListener("click",()=>this.copy())},close(){this.w.close()},async copy(){const b=this.w.getElement().querySelector(".pre-text").textContent;try{await navigator.clipboard.writeText(b)}catch(c){console.error("Errore  ",c)}}}),WndDiv=a=>({w:UaWindowAdm.create(a),out:null,show(b){wnds.closeAll();b=`
<div class="window-text">
<div class="btn-wrapper">
<button class="btn-copy tt-left" data-tt="Copia">
<svg class="copy-icon" viewBox="0 0 20 24">
<path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
</svg>
</button>
<button class="btn-close tt-left" data-tt="Chiudi" onclick="UaWindowAdm.closeThis(this)">X</button>
</div>
<div class="div-text">${b}</div>
</div>
    `;this.w.drag();this.w.setZ(12);this.w.vw_vh().setXY(16.5,10,-1);this.w.setHtml(b);this.w.show();this.w.getElement().querySelector(".btn-copy").addEventListener("click",()=>this.copy())},close(){this.w.close()},async copy(){const b=this.w.getElement().querySelector(".div-text").textContent;try{await navigator.clipboard.writeText(b)}catch(c){console.error("Errore  ",c)}}}),wnds={wdiv:null,wpre:null,wout:null,init(){this.wdiv=WndDiv("id_w0");this.wpre=WndPre("id_w1");this.wout=WndPre("id_out")},
closeAll(){UaWindowAdm.close("id_w0");UaWindowAdm.close("id_w1");UaWindowAdm.close("id_out")}},Menu={init(){const a=document.querySelector("#id-menu-btn");a.addEventListener("change",()=>{document.querySelector("body").classList.toggle("menu-open",a.checked);const c=document.querySelector("body"),d=document.querySelector("#id-menu-btn");c.classList.contains("menu-open")?d.setAttribute("data-tt","Close"):d.setAttribute("data-tt","Open")});const b=document.getElementById("id_log");UaLog.callHide=()=>
{b.classList.contains("active")&&b.classList.remove("active")};UaLog.callShow=()=>{b.classList.contains("active")||b.classList.add("active")};UaLog.setXY(54,13).setZ(111).new();UaLog.log_show("")},close(){const a=document.querySelector("#menu-toggle");document.querySelector("body").classList.remove("menu-open",a.checked);document.querySelector(".menu-btn").checked=!1},help(){wnds.wdiv.show(help0_html)},upload(){RagUpload.open()},uploadDir(){RagUpload.openDir()},async load(){alert("load")},log(){UaLog.toggle()}},
setResponseHtml=a=>{const b=document.querySelector("#id-text-out .div-text");b.innerHTML=a;b.scrollTop=b.scrollHeight},TextInput={wnd:null,init(){this.inp=document.querySelector(".text-input");document.addEventListener("keydown",a=>{document.activeElement!==this.inp&&("F1 F2 F3 F4 F5 F6 F7 F8 F9 F10 F11 F12 Control Alt Shift Meta CapsLock Escape PrintScreen ScrollLock Pause Insert Delete Home End PageUp PageDown ArrowLeft ArrowRight ArrowUp ArrowDown".split(" ").includes(a.key)||a.ctrlKey||a.metaKey||
a.preventDefault())});document.querySelector(".clear-button").addEventListener("click",()=>{this.inp.value="";this.inp.focus()});this.inp.addEventListener("keydown",a=>this.handleEnter(a));document.querySelector(".send-input").addEventListener("click",()=>this.send());document.querySelector(".send2-input").addEventListener("click",()=>this.send2());document.querySelector(".clear-input").addEventListener("click",()=>this.clear())},handleEnter(a){"Enter"!==a.key||a.shiftKey||(a.preventDefault(),this.send2())},
async send(){if(this.inp.value)if(0==DataMgr.readDbDocNames().length)alert("Non vi sono documenti da elaborare.\n  Se vuoi iniziare una conversazione usa il pulsante verde o return  ");else{if(Rag.ragContext&&!await confirm("Vuoi iniziare una nuova elabrazione ?"))return"";showSpinner();setResponseHtml("");var a=this.inp.value.trim();try{let b=await Rag.requestDocsRAG(a);setResponseHtml(b);this.inp.value="";UaLog.close()}catch(b){console.error("ERROR Send",b),a=errorDumps(b),alert(a)}hideSpinner()}else alert("Ricorda di scrivere la Query  ")},
async send2(){if(this.inp.value){showSpinner();ThreadMgr.isFirst();var a=this.inp.value.trim();try{let b=await Rag.requestContext(a);if(""==b){hideSpinner();return}setResponseHtml(b);this.inp.value=""}catch(b){console.error("Error send2",b),a=errorDumps(b),alert(a)}hideSpinner()}else alert("Ricorda di scrivere la Query  ")},async clear(){await confirm("Confermi cancellazione conversazione? ")&&(this.inp.value="",setResponseHtml(""),ThreadMgr.delete())}};
TextOutput={init(){this.copyBtn=document.querySelector(".copy-output");this.copyBtn.addEventListener("click",()=>this.copy());document.querySelector(".clear-output").addEventListener("click",()=>this.clear());document.querySelector(".wnd-output").addEventListener("click",()=>this.openWnd())},openWnd(){var a=document.querySelector("#id-text-out .div-text");a=textFormatter(a.textContent);wnds.wout.show(a)},async copy(){const a=document.querySelector("#id-text-out .div-text");let b=a.textContent;if(!(2>
b.trim().length)){a.classList.add("copied");this.copyBtn.classList.add("copied");try{b=textFormatter(b),await navigator.clipboard.writeText(b)}catch(c){console.error("Errore  ",c)}setTimeout(()=>{this.copyBtn.classList.remove("copied");a.classList.remove("copied")},5E3)}},clear(){document.querySelector("#id-text-out .div-text").textContent=""}};const RagUpload={open(){const a=UaWindowAdm.create("id_upload");a.drag();a.setZ(12);a.vw_vh().setXY(16.5,10,-1);a.setHtml('\n      <div class="window-text">\n        <div class="btn-wrapper">\n          <button class="btn-close" title="chiudi" onclick="UaWindowAdm.closeThis(this)">X</button>\n        </div>\n        <div class="upload">\n          <h4>Upload file Text / PDF / DOCX</h4>\n          <form id="uploadForm">\n              <input class="file" type="file" id="id_fileupload" >\n              <button type="button" onclick="RagUpload.upload();">Upload and Convert</button>\n          </form>\n          <div id="result" class="result"></div>\n        </div>\n      </div>\n    ');
a.show()},async upload(){const a=document.getElementById("id_fileupload").files[0];if(a){var b=a.name;if(DataMgr.doc_names.includes(b))alert("Il file \u00e8 gi\u00e0 in archivio");else{var c=document.getElementById("result"),d=a.name.split(".").pop().toLowerCase();showSpinner();try{let e;if("pdf"===d){const f=new PdfHandler;await f.loadPdfJs();e=await f.extractTextFromPDF(a);f.cleanup()}else if("txt"===d)e=await readTextFile(a);else if("docx"===d){const f=new DocxHandler;await f.loadMammoth();e=await f.extractTextFromDocx(a);
f.cleanup()}else{alert("Formato file non supportato.");return}DataMgr.addDoc(b,e);c.innerHTML=`<br><br> ${b}<br><br>caricato e salvato nella memoria locale`}catch(e){console.error("Error:",e),alert("Errore durante l'estrazione del testo dal file.")}finally{hideSpinner()}}}else alert("Nessun file selezionato.")},openDir(){const a=UaWindowAdm.create("id_upload");a.drag();a.setZ(12);a.vw_vh().setXY(16.5,10,-1);a.setHtml('\n      <div class="window-text">\n        <div class="btn-wrapper">\n          <button class="btn-close" title="chiudi" onclick="UaWindowAdm.closeThis(this)">X</button>\n        </div>\n        <div class="upload">\n          <h4>Upload files Text / PDF / DOCX</h4>\n          <form id="uploadForm">\n              <input id="id_fileupload" class="file" type="file"  webkitdirectory mozdirectory msdirectory odirectory directory multiple />\n              <button type="button" onclick="RagUpload.uploadDir();">Upload and Convert</button>\n          </form>\n          <div class="result" id="result"></div>\n        </div>\n      </div>\n    ');
a.show()},async uploadDir(){var a=document.getElementById("id_fileupload").files;if(a&&0!=a.length){var b=[];showSpinner();try{for(const c of a){const d=c.name;UaLog.log_show(d);if(DataMgr.doc_names.includes(d)){UaLog.log_show(d+" : \u00e8 gi\u00e0 in archivio");continue}const e=c.name.split(".").pop().toLowerCase();let f;if("pdf"===e){const g=new PdfHandler;await g.loadPdfJs();f=await g.extractTextFromPDF(c);g.cleanup()}else if("txt"===e)f=await readTextFile(c);else if("docx"===e){const g=new DocxHandler;
await g.loadMammoth();f=await g.extractTextFromDocx(c);g.cleanup()}else{alert("Formato file non supportato.");return}DataMgr.addDoc(d,f);b.push(`${d}`)}}catch(c){console.error("Error:",c),alert("Errore durante l'estrazione del testo dal file.")}finally{hideSpinner()}a=document.getElementById("result");b=b.join("<br>");a.innerHTML=b}else alert("Nessun file selezionato.")}};
class PdfHandler{constructor(){this.workerScriptElement=this.scriptElement=this.pdfjsLib=null}async loadPdfJs(){window.pdfjsLib||(this.scriptElement=document.createElement("script"),this.scriptElement.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js",document.body.appendChild(this.scriptElement),await new Promise(a=>{this.scriptElement.onload=()=>{this.workerScriptElement=document.createElement("script");this.workerScriptElement.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js";
document.body.appendChild(this.workerScriptElement);this.workerScriptElement.onload=a}}));this.pdfjsLib=window["pdfjs-dist/build/pdf"];this.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js"}async extractTextFromPDF(a){a=await a.arrayBuffer();a=await this.pdfjsLib.getDocument({data:a}).promise;let b="";for(let c=1;c<=a.numPages;c++){const d=(await (await a.getPage(c)).getTextContent()).items.map(e=>e.str).join(" ");b+=d+"\n"}return b}cleanup(){this.scriptElement&&
(document.body.removeChild(this.scriptElement),this.scriptElement=null);this.workerScriptElement&&(document.body.removeChild(this.workerScriptElement),this.workerScriptElement=null);this.pdfjsLib=null;window.gc&&window.gc()}}
class DocxHandler{constructor(){this.scriptElement=this.mammoth=null}async loadMammoth(){window.mammoth?this.mammoth=window.mammoth:(this.scriptElement=document.createElement("script"),this.scriptElement.src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.11/mammoth.browser.min.js",document.body.appendChild(this.scriptElement),await new Promise(a=>{this.scriptElement.onload=()=>{this.mammoth=window.mammoth;a()}}))}async extractTextFromDocx(a){a=await a.arrayBuffer();return(await this.mammoth.extractRawText({arrayBuffer:a})).value}cleanup(){this.scriptElement&&
(document.body.removeChild(this.scriptElement),this.scriptElement=null);this.mammoth=null;window.gc&&window.gc()}}async function readTextFile(a){if(!a||"text/plain"!==a.type)throw Error("Invalid file type. Please select a text file.");return new Promise((b,c)=>{const d=new FileReader;d.onload=e=>b(e.target.result);d.onerror=e=>c(Error("Error reading file: "+e.message));d.readAsText(a)})};const DialogManager={createDialog(a,b){const c=document.createElement("div"),d=document.createElement("div");c.className=`${a}-dialog`;c.classList.add("inv");d.className="overlay";c.innerHTML=`
          <h4>${b}</h4>
          <div class="buttons inv">
            <button class="ok inv">OK</button>
            ${"confirm"===a?'<button class="cancel inv">Annulla</button>':""}
          </div>
        `;[c,d].forEach(e=>{e.classList.add("show");document.body.appendChild(e)});return{dialog:c,overlay:d}},closeDialog(a,b){[a,b].forEach(c=>{c.classList.remove("show");setTimeout(()=>c.remove(),300)})},showDialog(a,b){return new Promise(c=>{const {dialog:d,overlay:e}=this.createDialog(a,b);d.querySelector(".ok").onclick=()=>{this.closeDialog(d,e);c("confirm"===a)};"confirm"===a&&(d.querySelector(".cancel").onclick=()=>{this.closeDialog(d,e);c(!1)})})}},nativeAlert=window.alert,nativeConfirm=
window.confirm;window.alert=function(a){a instanceof Error&&(a=a.message);return DialogManager.showDialog("alert",a)};window.confirm=function(a){return DialogManager.showDialog("confirm",a)};const nodrag_tds=["input","select","a"],nodrag_cls="nodrag";
var UaDrag=function(a){return function(b){let c=0,d=0,e=0,f=0;const g=function(h){h=h||window.event;h.preventDefault();c=e-h.clientX;d=f-h.clientY;e=h.clientX;f=h.clientY;b.style.top=b.offsetTop-d+"px";b.style.left=b.offsetLeft-c+"px"},k=function(){document.onmouseup=null;document.onmousemove=null};b.onmousedown=function(h){h=h||window.event;let l=h.target;!(l=l||null)||nodrag_tds.includes(l.tagName.toLowerCase())||l.classList.contains(nodrag_cls)||(h.preventDefault(),e=h.clientX,f=h.clientY,document.onmouseup=
k,document.onmousemove=g)}}(a)};const UaJtfh=()=>({rows:[],init(){this.rows=[];return this},insert(a){this.rows.unshift(a);return this},append(a){this.rows.push(a);return this},text(a=""){return this.rows.join(a)},html(a=""){return this.rows.join(a).replace(/\s+|\[rn\]/g," ")}});function formatRow(a,b){return a.map((c,d)=>{d=b[d];return 0>d?c.toString().padStart(Math.abs(d)," "):c.toString().padEnd(d," ")}).join(" ")}
var UaLog={callHide:function(){},callShow:function(){},active:!1,wind:null,x:null,y:null,z:null,max_length:2E3,msg_id:"ualogmsg_",new:function(){null==this.wind&&(this.wind=UaWindowAdm.create("ualog_id"),this.wind.drag());this.wind.setHtml('\n           <button type="button" class="clear " onclick="javascript:UaLog.cls();">Clear</button>\n           <button type="button" class="close " onclick="javascript:UaLog.close();">Close</button>\n           <pre id="ualogmsg_" ></pre>');this.wind.addClassStyle("inv");
this.x?this.wind.vw_vh().setXY(this.x,this.y,-1):this.wind.setCenter(-1);this.z&&this.wind.setZ(this.z);return this},setXY(a,b){this.x=a;this.y=b;return this},setZ(a){this.z=a;return this},prn_(...a){a=a.join("\n");let b=document.getElementById(this.msg_id);b.textContent=b.textContent+a+"\n"},print(...a){null!=this.wind&&this.active&&this.prn_(...a)},log(...a){null!=this.wind&&this.prn_(...a)},log_show(...a){null!=this.wind&&(this.active||this.toggle(),this.prn_(...a))},cls(){if(null!=this.wind)return document.getElementById(this.msg_id).innerHTML=
"",this},close(){null!=this.wind&&(this.wind.hide(),this.active=!1,this.callHide())},toggle(){null!=this.wind&&(this.active?(this.active=!1,this.wind.hide(),this.callHide()):(this.active=!0,this.wind.show(),this.callShow()))}};var UaWindowAdm={ws:{},create(a,b=null){let c=document.getElementById(a);c||(c=document.createElement("div"),b?document.getElementById(b).appendChild(c):document.body.appendChild(c),c.id=a,c.setAttribute("data-name","ua-window"),b=this.newUaWindow(c),this.ws[a]=b);a=this.ws[a];c.style.display="none";return a},get(a){return this.ws[a]?this.ws[a]:null},show(a){this.ws[a]&&this.ws[a].show()},close(a){this.ws[a]&&this.ws[a].close()},toggle(a){this.ws[a]&&this.ws[a].toggle()},hide(a){this.ws[a]&&this.ws[a].hide()},
closeThis(a){a=a.closest('[data-name="ua-window"]').id;this.ws[a].close()},showAll(){for(let a in this.ws)this.ws[a].show()},hideAll(){for(let a in this.ws)this.ws[a].hide()},closeAll(){for(let a in this.ws)this.ws[a].close()},remove(a){this.ws[a]&&(document.getElementById(a).remove(),this.ws[a]=null,delete this.ws[a])},removeAll(){for(let a in this.ws)this.remove(a);this.ws={}},newUaWindow(a){let b={initialize(c){this.w=c;this.wy=this.wx="0px";this.isVisible=this.isOpen=!1;this.firstShow=!0;this.wz=
this.pos=0;this.vh=this.vw="px"},vw_vh(){this.vw="vw";this.vh="vh";return this},addClassStyle(c){this.w.classList.contains(c)||this.w.classList.add(c);return this},removeClassStyle(c){this.w.classList.contains(c)&&this.w.classList.remove(c);return this},getWindow(){alert("getWindow => ??");return this.w},getElement(){return this.w},getId(){return this.w.id},setStyle(c){for(const d in c)this.w.style[d]=c[d];return this},setHtml(c){this.w.innerHTML=c;return this},getHtml(){return this.w.innerHTML},
setXY(c,d,e=0){this.wx=c;this.wy=d;this.pos=e;return this},setCenterY(c,d){this.setXY((window.innerWidth-this.w.clientWidth)/2,c,d);return this},setCenter(c){this.setXY((window.innerWidth-this.w.clientWidth)/2,(window.innerHeight-this.w.clientHeight)/2,c);return this},linkToId(c,d,e,f){c=document.getElementById(c);this.linkToElement(c,d,e,f);return this},linkToElement(c,d,e,f){d=c.offsetLeft+c.offsetWidth+d;c=c.offsetTop+e;0>c&&(c=0);this.setXY(d,c,f);return this},setZ(c){this.wz=c;return this},reset(){this.firstShow=
!0;return this},toggle(){this.isVisible?this.hide():this.show();return this},show(){if(this.firstShow||1==this.pos||0===this.pos&&!1===this.isVisible)this.w.style.position="absolute",this.w.style.marginLeft=0,this.w.style.marginTop=0,this.w.style.top=`${this.wy}${this.vh}`,0<=this.wx?this.w.style.left=`${this.wx}${this.vw}`:this.w.style.right=-`${this.wx}${this.vw}`,0<this.wz&&(this.w.style.zIndex=this.wz);this.w.style.display="";this.firstShow=!1;this.isOpen=this.isVisible=!0;return this},hide(){this.w.style.display=
"none";this.isVisible=!1;return this},close(){this.w.style.display="none";this.w.innerHTML="";this.isOpen=!1;return this},remove(){UaWindowAdm.remove(this.w.id);return null},drag(){UaDrag(this.w);return this}};b.initialize(a);return b}};
